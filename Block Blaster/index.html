<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Game Xếp Gạch 9x9</title>
<style>
  :root{
    --cell-size: 36px;
    --gap: 2px;
    --board-size: calc(var(--cell-size) * 9 + var(--gap) * 8);
  }

  .cell.hover {
  background: rgba(255,255,0,0.4) !important;
  border: 1px solid yellow;
}
  body{
    font-family: system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#0f172a,#071132);
    color: #e6eef8;
    display:flex;
    gap:24px;
    padding:28px;
    align-items:flex-start;
    min-height:100vh;
  }
  .container{
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  .board {
    display:grid;
    grid-template-columns: repeat(9, var(--cell-size));
    grid-template-rows: repeat(9, var(--cell-size));
    gap: var(--gap);
    width: var(--board-size);
    height: var(--board-size);
    background:#071233;
    padding:8px;
    border-radius:8px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 2px 0 rgba(255,255,255,0.02);
  }
  .cell {
    width:var(--cell-size);
    height:var(--cell-size);
    background: rgba(255,255,255,0.03);
    border-radius:4px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    color:transparent;
    cursor:pointer;
    transition: background .08s ease;
  }
  .cell.filled{
    background: linear-gradient(135deg,#60a5fa,#7c3aed);
    color:#fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.35);
  }
  .sidebar{
    width:340px;
    background: rgba(255,255,255,0.03);
    border-radius:12px;
    padding:16px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.6);
  }
  h1{ margin:4px 0 10px 0; font-size:18px; }
  .pieces{
    display:flex;
    gap:12px;
    margin-top:8px;
    flex-wrap:wrap;
  }
  .piece {
    width:100px;
    min-height:100px;
    background: rgba(255,255,255,0.02);
    border-radius:8px;
    padding:8px;
    box-sizing:border-box;
    cursor:pointer;
    border:2px solid transparent;
  }
  .piece.selected{
    border-color: #facc15;
    box-shadow: 0 6px 20px rgba(250,204,21,0.12);
  }
  .mini-grid{
    display:grid;
    grid-template-columns: repeat(5, 1fr);
    grid-auto-rows: 1fr;
    gap:4px;
    width:100%;
    aspect-ratio:1/1;
  }
  .mini-cell{
    background: rgba(255,255,255,0.03);
    border-radius:3px;
    width:100%;
    height:100%;
  }
  .mini-cell.on{
    background: linear-gradient(135deg,#7dd3fc,#c084fc);
  }
  .info { margin-top:12px; font-size:14px; line-height:1.4; color:#dbeafe; }
  .btn{
    display:inline-block;
    padding:8px 12px;
    background:#0ea5e9;
    color:#021024;
    font-weight:700;
    border-radius:8px;
    margin-top:10px;
    cursor:pointer;
  }
  .score{ font-size:20px; font-weight:800; color:#bbf7d0; margin-top:6px; }
  .message{
    margin-top:12px;
    padding:10px;
    border-radius:8px;
    background: rgba(255,255,255,0.02);
    min-height:40px;
  }
  .small{ font-size:12px; color:#94a3b8; margin-top:6px;}
  footer{ position:fixed; left:12px; bottom:8px; font-size:12px; color:#93c5fd; }
</style>
</head>
<body>
  <div class="container">
    <div>
      <div class="board" id="board" role="grid" aria-label="Game board"></div>
      <div style="margin-top:12px;">
        <button class="btn" id="newGame">Bắt đầu lại</button>
        <span class="small" style="margin-left:12px;">Click chọn cục rồi click vào ô để đặt (ô là top-left của bounding box).</span>
      </div>
    </div>

    <div class="sidebar">
      <h1>Game Xếp Gạch 9×9</h1>
      <div><strong>Điểm:</strong> <span id="score" class="score">0</span></div>
      <div class="info">
        <div style="margin-top:8px;"><strong>3 cục hiện tại:</strong></div>
        <div class="pieces" id="pieces"></div>
      </div>
      <div class="message" id="message">Chơi thôi nào!</div>
      <div style="margin-top:10px;">
        <button class="btn" id="hintBtn">Kiểm tra chỗ đặt khả dĩ</button>
        <button class="btn" id="nextBtn" style="background:#10b981; margin-left:8px;">Lấy lượt mới (nếu đã đặt hết)</button>
      </div>
      <div class="small">Mỗi ô được xóa = 5 điểm.</div>
    </div>
  </div>

<footer>Simple block game — Made for you</footer>

<script>
(function(){
  const ROWS = 9, COLS = 9;
  const POINT_PER_CELL = 5;

  const board = Array.from({length: ROWS}, ()=> Array(COLS).fill(0));
  let score = 0;
  let pieces = [];
  let selectedPieceIndex = -1;
  let gameOver = false;

  const boardEl = document.getElementById('board');
  const piecesEl = document.getElementById('pieces');
  const scoreEl = document.getElementById('score');
  const messageEl = document.getElementById('message');

  let hoverCells = [];   // cells currently highlighted for preview

  function clearHover(){
    hoverCells.forEach(el => el.classList.remove("hover"));
    hoverCells = [];
  }

  function buildGrid(){
    boardEl.innerHTML = '';
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell = document.createElement('div');
        cell.className='cell';
        cell.dataset.r=r; 
        cell.dataset.c=c;

        cell.addEventListener("mouseenter", ()=> onHover(r,c));
        cell.addEventListener("mouseleave", clearHover);
        cell.addEventListener("click", ()=> onCellClick(r,c));

        boardEl.appendChild(cell);
      }
    }
  }

  function updateBoardUI(){
    const nodes = boardEl.children;
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const idx = r*COLS + c;
        const el = nodes[idx];
        if(board[r][c]) el.classList.add('filled'); 
        else el.classList.remove('filled');
      }
    }
  }

  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function generateRandomPiece(id){
    if(Math.random() < 0.35){
      const len = randInt(1,5);
      const dir = Math.random() < 0.5 ? 'h' : 'v';
      const shape = [];
      for(let i=0;i<len;i++){
        shape.push(dir==='h' ? [0,i] : [i,0]);
      }
      return {id, shape, h: dir==='h'?1:len, w: dir==='h'?len:1};
    }

    const used=[];
    for(let r=0;r<3;r++)
      for(let c=0;c<3;c++)
        if(Math.random()<0.45) used.push([r,c]);

    if(used.length===0) used.push([1,1]);

    const rs = used.map(v=>v[0]), cs=used.map(v=>v[1]);
    const rmin=Math.min(...rs), rmax=Math.max(...rs);
    const cmin=Math.min(...cs), cmax=Math.max(...cs);

    const shape = used.map(([r,c])=>[r-rmin,c-cmin]);
    return {id, shape, h:rmax-rmin+1, w:cmax-cmin+1};
  }

  function generateThreePieces(){
    pieces = [];
    for(let i=0;i<3;i++) pieces.push(generateRandomPiece(i));
    selectedPieceIndex = -1;
    renderPieces();
  }

  function renderPieces(){
    piecesEl.innerHTML='';
    pieces.forEach((p,idx)=>{
      const box=document.createElement("div");
      box.className="piece"+(selectedPieceIndex===idx?" selected":"");
      box.addEventListener("click", ()=>{
        selectedPieceIndex=idx;
        renderPieces();
        clearHover();
      });

      const grid=document.createElement("div");
      grid.className="mini-grid";
      const preview=Array.from({length:25},()=>{
        const d=document.createElement("div");
        d.className='mini-cell';
        return d;
      });

      p.shape.forEach(([r,c])=>{
        const rr=r+1, cc=c+1;
        preview[rr*5+cc].classList.add('on');
      });
      preview.forEach(v=>grid.appendChild(v));
      box.appendChild(grid);
      piecesEl.appendChild(box);
    });
  }

  function canPlaceAt(p, r, c){
    if(r+p.h>ROWS || c+p.w>COLS) return false;
    for(const [dr,dc] of p.shape){
      if(board[r+dr][c+dc]) return false;
    }
    return true;
  }

  function onHover(r,c){
    clearHover();
    if(selectedPieceIndex===-1 || gameOver) return;

    const p = pieces[selectedPieceIndex];
    if(!p) return;

    if(!canPlaceAt(p,r,c)) return;

    // highlight preview
    const nodes = boardEl.children;
    p.shape.forEach(([dr,dc])=>{
      const idx = (r+dr)*COLS + (c+dc);
      const el = nodes[idx];
      el.classList.add("hover");
      hoverCells.push(el);
    });
  }

  function onCellClick(r,c){
    if(gameOver || selectedPieceIndex===-1) return;

    const p = pieces[selectedPieceIndex];
    if(!p) return;

    if(!canPlaceAt(p,r,c)){
      messageEl.textContent="Không đặt được tại đây.";
      return;
    }

    // place piece
    p.shape.forEach(([dr,dc])=>{
      board[r+dr][c+dc] = 1;
    });
    pieces = pieces.filter(x=>x.id!==p.id);
    selectedPieceIndex=-1;

    clearHover();
    updateBoardUI();
    renderPieces();
    messageEl.textContent="Đặt thành công!";

    const cleared=checkAndClearLines();
    if(cleared>0){
      score += cleared*POINT_PER_CELL;
      scoreEl.textContent = score;
    }

    if(pieces.length===0) generateThreePieces();

    if(checkGameOver()) finishGame();
  }

  function checkAndClearLines(){
    let clearedCells=0;

    for(let r=0;r<ROWS;r++){
      if(board[r].every(v=>v===1)){
        for(let c=0;c<COLS;c++){
          board[r][c]=0;
          clearedCells++;
        }
      }
    }

    for(let c=0;c<COLS;c++){
      let full=true;
      for(let r=0;r<ROWS;r++){
        if(board[r][c]===0){ full=false; break; }
      }
      if(full){
        for(let r=0;r<ROWS;r++){
          board[r][c]=0;
          clearedCells++;
        }
      }
    }

    if(clearedCells>0) updateBoardUI();
    return clearedCells;
  }

  function anyPossible(p){
    for(let r=0;r<=ROWS-p.h;r++)
      for(let c=0;c<=COLS-p.w;c++)
        if(canPlaceAt(p,r,c)) return true;
    return false;
  }

  function checkGameOver(){
    for(const p of pieces) if(anyPossible(p)) return false;
    return true;
  }

  function finishGame(){
    gameOver=true;

    if(score<100000){
      messageEl.innerHTML=`Kết thúc — ${score}. <b>mày ngu ko qua được 100000 điểm</b>`;
    } else {
      score+=1000;
      messageEl.innerHTML=`Kết thúc — +1k. <b>mày ngu ko qua được A+1k điểm</b>`;
      scoreEl.textContent=score;
    }
  }

  function start(){
    for(let r=0;r<ROWS;r++)
      for(let c=0;c<COLS;c++) board[r][c]=0;

    score=0;
    scoreEl.textContent="0";
    gameOver=false;

    buildGrid();
    updateBoardUI();
    generateThreePieces();
    messageEl.textContent="Chọn cục rồi đưa chuột vào bảng để xem vị trí chính xác!";
  }

  start();
})();
</script>

</body>
</html>
