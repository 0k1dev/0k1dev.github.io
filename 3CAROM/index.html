<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Carom 3 BÄƒng â€“ Pro 2P</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#fff;
  font-family:Arial;
  display:flex;
  flex-direction:column;
  align-items:center
}
h1{color:#00e5ff;margin:8px}

.table-wrap{
  position:relative;
  display:inline-block;
}

/* ===== POWER BAR ===== */
.power-wrap{
  position:absolute;
  left:-40px;
  top:20px;
  width:16px;
  height:380px;
  background:#222;
  border-radius:8px;
}
.power-bar{
  position:absolute;
  bottom:0;
  width:100%;
  height:0%;
  background:linear-gradient(#0f0,#ff0,#f00);
  border-radius:8px;
}

canvas{
  background:#145214;
  border:18px solid #5b2c06;
  border-radius:12px;
}

/* ===== QR ===== */
.qr-box{
  position:absolute;
  top:10px;
  right:-160px;
  width:150px;
  text-align:center;
}
.qr-box img{
  width:140px;
  background:#fff;
  padding:5px;
  border-radius:10px;
}
.qr-text{margin-top:6px;color:#ccc;font-size:14px}

.info{
  margin-top:8px;
  font-size:14px;
  color:#ccc
}
</style>
</head>

<body>
<h1>ðŸŽ± Carom 3 BÄƒng â€“ Pro Training (2 Players)</h1>

<div class="table-wrap">
  <div class="power-wrap">
    <div class="power-bar" id="powerBar"></div>
  </div>

  <canvas id="c" width="900" height="450"></canvas>

  <div class="qr-box">
    <img src="https://img.vietqr.io/image/ACB-43146717-compact2.png?addInfo=Donate+Carom">
    <div class="qr-text">á»¦ng há»™ tÃ¡c giáº£</div>
  </div>
</div>

<div class="info" id="info">
  Player 1 | SPACE láº¥y lá»±c | A/D xoÃ¡y | S = khÃ´ng xoÃ¡y
</div>

<script>
/* ===== CANVAS ===== */
const c=document.getElementById("c");
const ctx=c.getContext("2d");

/* ===== CONST ===== */
const R=10;
const FRICTION=0.992;
const MAX_POWER=160;

/* ===== SLOW MOTION ===== */
let TIME_SCALE=1, slowTimer=0;
const triggerSlow=()=>{TIME_SCALE=0.25;slowTimer=35};

/* ===== BALL ===== */
class Ball{
  constructor(x,y,color){
    this.x=x;this.y=y;
    this.vx=0;this.vy=0;
    this.color=color;
  }
}
let white=new Ball(150,225,"#fff");
let red=new Ball(450,160,"red");
let yellow=new Ball(600,290,"yellow");
const balls=[white,red,yellow];

/* ===== GAME STATE ===== */
let showCue=false, aiming=false;
let aimX=0, aimY=0;
let charging=false, power=0, spin=0;

/* ===== PLAYER ===== */
let currentPlayer=1;
let score=[0,0];

/* ===== CAROM CHECK ===== */
let cushionCount=0, hitRed=false, hitYellow=false;

/* ===== REPLAY ===== */
let replayFrames=[];
let replaying=false, replayIndex=0;

/* ===== DRAW ===== */
function drawBall(b){
  ctx.beginPath();
  ctx.arc(b.x,b.y,R,0,6.28);
  ctx.fillStyle=b.color;
  ctx.fill();
}

/* ===== CUE ===== */
function drawCue(){
  if(!showCue) return;
  let dx=aimX-white.x, dy=aimY-white.y;
  let ang=Math.atan2(dy,dx);
  ctx.save();
  ctx.translate(white.x,white.y);
  ctx.rotate(ang);
  ctx.fillStyle="#deb887";
  ctx.fillRect(-(40+power),-2,220,4);
  ctx.restore();
}

/* ===== COLLISION ===== */
function collide(a,b){
  const dx=b.x-a.x, dy=b.y-a.y;
  const dist=Math.hypot(dx,dy);
  if(dist>=2*R||dist===0) return;

  triggerSlow();

  const nx=dx/dist, ny=dy/dist;
  const tx=-ny, ty=nx;
  const dpTanA=a.vx*tx+a.vy*ty;
  const dpTanB=b.vx*tx+b.vy*ty;
  const dpNormA=a.vx*nx+a.vy*ny;
  const dpNormB=b.vx*nx+b.vy*ny;

  a.vx=tx*dpTanA+nx*dpNormB*0.98;
  a.vy=ty*dpTanA+ny*dpNormB*0.98;
  b.vx=tx*dpTanB+nx*dpNormA*0.98;
  b.vy=ty*dpTanB+ny*dpNormA*0.98;

  if(a===white||b===white){
    if(a===red||b===red) hitRed=true;
    if(a===yellow||b===yellow) hitYellow=true;
  }
}

/* ===== UPDATE ===== */
function update(){
  ctx.clearRect(0,0,c.width,c.height);

  if(replaying){
    let f=replayFrames[replayIndex++];
    balls.forEach((b,i)=>{b.x=f[i].x;b.y=f[i].y});
    if(replayIndex>=replayFrames.length){
      replaying=false;
    }
  }else{
    replayFrames.push(balls.map(b=>({x:b.x,y:b.y})));
    if(replayFrames.length>120) replayFrames.shift();

    balls.forEach(b=>{
      b.x+=b.vx*TIME_SCALE;
      b.y+=b.vy*TIME_SCALE;
      b.vx*=Math.pow(FRICTION,TIME_SCALE);
      b.vy*=Math.pow(FRICTION,TIME_SCALE);

      if(b.x<R||b.x>c.width-R||b.y<R||b.y>c.height-R){
        if(b===white){cushionCount++;triggerSlow();}
      }
      b.x=Math.max(R,Math.min(c.width-R,b.x));
      b.y=Math.max(R,Math.min(c.height-R,b.y));
    });

    collide(white,red);
    collide(white,yellow);
    collide(red,yellow);
  }

  balls.forEach(drawBall);
  drawCue();

  ctx.fillStyle="#fff";
  ctx.font="16px Arial";
  ctx.fillText(`P1: ${score[0]}   P2: ${score[1]}`,20,24);

  if(cushionCount>=3&&hitRed&&hitYellow&&white.vx===0&&white.vy===0){
    score[currentPlayer-1]++;
    replaying=true;
    replayIndex=0;
    cushionCount=0;hitRed=hitYellow=false;
  }

  if(slowTimer>0 && --slowTimer===0) TIME_SCALE=1;
  requestAnimationFrame(update);
}

/* ===== INPUT ===== */
c.onmousedown=e=>{
  if(white.vx||white.vy) return;
  const r=c.getBoundingClientRect();
  aimX=e.clientX-r.left;
  aimY=e.clientY-r.top;
  showCue=aiming=true;
};
c.onmousemove=e=>{
  if(!aiming) return;
  const r=c.getBoundingClientRect();
  aimX=e.clientX-r.left;
  aimY=e.clientY-r.top;
};

window.onkeydown=e=>{
  if(e.code==="Space") charging=true;
};
window.onkeyup=e=>{
  if(e.code==="Space"){
    let dx=aimX-white.x, dy=aimY-white.y;
    let len=Math.hypot(dx,dy)||1;
    let force=power*0.38;
    white.vx=(dx/len)*force;
    white.vy=(dy/len)*force;
    power=0;charging=false;showCue=false;aiming=false;
    currentPlayer=currentPlayer===1?2:1;
    document.getElementById("info").textContent=
      `Player ${currentPlayer} | SPACE láº¥y lá»±c`;
  }
};

/* ===== POWER BAR ===== */
setInterval(()=>{
  if(charging) power=Math.min(power+4,MAX_POWER);
  document.getElementById("powerBar").style.height=
    (power/MAX_POWER*100)+"%";
},30);

update();
</script>
</body>
</html>
