<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Carom 3 BÄƒng â€“ Pro 2P (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;background:#0b0b0b;color:#fff;
  font-family:Arial;display:flex;
  flex-direction:column;align-items:center
}
h1{color:#00e5ff;margin:8px}
.table-wrap{position:relative;display:inline-block}

/* POWER */
.power-wrap{
  position:absolute;left:-40px;top:20px;
  width:16px;height:380px;background:#222;border-radius:8px
}
.power-bar{
  position:absolute;bottom:0;width:100%;height:0%;
  background:linear-gradient(#0f0,#ff0,#f00);border-radius:8px
}

canvas{
  background:#145214;
  border:18px solid #5b2c06;
  border-radius:12px;
}
.info{margin-top:8px;color:#ccc}
</style>
</head>

<body>
<h1>ðŸŽ± Carom 3 BÄƒng â€“ Pro 2P</h1>

<div class="table-wrap">
  <div class="power-wrap"><div id="powerBar" class="power-bar"></div></div>
  <canvas id="c" width="900" height="450"></canvas>
</div>

<div class="info" id="info">Player 1 | SPACE láº¥y lá»±c</div>

<script>
const c=document.getElementById("c");
const ctx=c.getContext("2d");

const R=10, FRICTION=0.992, MAX_POWER=160;
let TIME_SCALE=1;

/* ===== BALL ===== */
class Ball{
  constructor(x,y,color){
    this.x=x;this.y=y;this.vx=0;this.vy=0;this.color=color;
    this.hitWallX=false;this.hitWallY=false;
  }
  moving(){ return Math.hypot(this.vx,this.vy)>0.05 }
}
const white=new Ball(150,225,"#fff");
const red=new Ball(450,160,"red");
const yellow=new Ball(600,290,"yellow");
const balls=[white,red,yellow];

/* ===== STATE ===== */
let aiming=false, showCue=false;
let aimX=0, aimY=0;
let charging=false, power=0;

/* ===== GAME ===== */
let player=1, score=[0,0];
let cushion=0, hitRed=false, hitYellow=false;
let replay=[], replaying=false, rIndex=0;
let shotInProgress=false;

/* ===== DRAW ===== */
function drawBall(b){
  ctx.beginPath();ctx.arc(b.x,b.y,R,0,6.28);
  ctx.fillStyle=b.color;ctx.fill();
}
function drawCue(){
  if(!showCue) return;
  let dx=aimX-white.x, dy=aimY-white.y;
  let a=Math.atan2(dy,dx);
  ctx.save();
  ctx.translate(white.x,white.y);
  ctx.rotate(a);
  ctx.fillStyle="#deb887";
  ctx.fillRect(-(40+power),-2,220,4);
  ctx.restore();
}

/* ===== COLLISION ===== */
function collide(a,b){
  let dx=b.x-a.x, dy=b.y-a.y;
  let d=Math.hypot(dx,dy);
  if(d>=2*R||d===0) return;
  TIME_SCALE=0.25; setTimeout(()=>TIME_SCALE=1,120);

  let nx=dx/d, ny=dy/d, tx=-ny, ty=nx;
  let dpTanA=a.vx*tx+a.vy*ty;
  let dpTanB=b.vx*tx+b.vy*ty;
  let dpNormA=a.vx*nx+a.vy*ny;
  let dpNormB=b.vx*nx+b.vy*ny;

  a.vx=tx*dpTanA+nx*dpNormB*0.98;
  a.vy=ty*dpTanA+ny*dpNormB*0.98;
  b.vx=tx*dpTanB+nx*dpNormA*0.98;
  b.vy=ty*dpTanB+ny*dpNormA*0.98;

  if(a===white||b===white){
    if(a===red||b===red) hitRed=true;
    if(a===yellow||b===yellow) hitYellow=true;
  }
}

/* ===== UPDATE ===== */
function update(){
  ctx.clearRect(0,0,c.width,c.height);

  if(replaying){
    let f=replay[rIndex++];
    balls.forEach((b,i)=>{b.x=f[i].x;b.y=f[i].y});
    if(rIndex>=replay.length){ replaying=false; }
  }else{
    if(shotInProgress){
      replay.push(balls.map(b=>({x:b.x,y:b.y})));
      if(replay.length>140) replay.shift();
    }

    balls.forEach(b=>{
      b.x+=b.vx*TIME_SCALE; b.y+=b.vy*TIME_SCALE;
      b.vx*=FRICTION; b.vy*=FRICTION;

      if(b.x<R&&!b.hitWallX){ b.vx=Math.abs(b.vx); b.hitWallX=true; if(b===white)cushion++ }
      if(b.x>c.width-R&&!b.hitWallX){ b.vx=-Math.abs(b.vx); b.hitWallX=true; if(b===white)cushion++ }
      if(b.y<R&&!b.hitWallY){ b.vy=Math.abs(b.vy); b.hitWallY=true; if(b===white)cushion++ }
      if(b.y>c.height-R&&!b.hitWallY){ b.vy=-Math.abs(b.vy); b.hitWallY=true; if(b===white)cushion++ }

      if(b.x>R&&b.x<c.width-R) b.hitWallX=false;
      if(b.y>R&&b.y<c.height-R) b.hitWallY=false;
    });

    collide(white,red);
    collide(white,yellow);
    collide(red,yellow);
  }

  balls.forEach(drawBall);
  drawCue();

  ctx.fillStyle="#fff";
  ctx.font="16px Arial";
  ctx.fillText(`P1: ${score[0]}   P2: ${score[1]}`,20,24);

  /* CHECK END SHOT */
  if(shotInProgress && balls.every(b=>!b.moving())){
    shotInProgress=false;
    if(cushion>=3 && hitRed && hitYellow){
      score[player-1]++;
      replaying=true; rIndex=0;
    }
    cushion=0; hitRed=hitYellow=false;
    player=player===1?2:1;
    info.textContent=`Player ${player} | SPACE láº¥y lá»±c`;
  }

  requestAnimationFrame(update);
}

/* ===== INPUT ===== */
c.onmousedown=e=>{
  if(shotInProgress) return;
  let r=c.getBoundingClientRect();
  aimX=e.clientX-r.left; aimY=e.clientY-r.top;
  showCue=aiming=true;
};
c.onmousemove=e=>{
  if(!aiming) return;
  let r=c.getBoundingClientRect();
  aimX=e.clientX-r.left; aimY=e.clientY-r.top;
};
window.onkeydown=e=>{ if(e.code==="Space") charging=true; };
window.onkeyup=e=>{
  if(e.code==="Space"&&showCue){
    let dx=aimX-white.x, dy=aimY-white.y;
    let l=Math.hypot(dx,dy)||1;
    white.vx=(dx/l)*power*0.38;
    white.vy=(dy/l)*power*0.38;
    power=0; charging=false; aiming=false; showCue=false;
    shotInProgress=true; replay=[];
  }
};

/* POWER BAR */
setInterval(()=>{
  if(charging) power=Math.min(power+4,MAX_POWER);
  powerBar.style.height=(power/MAX_POWER*100)+"%";
},30);

update();
</script>
</body>
</html>
